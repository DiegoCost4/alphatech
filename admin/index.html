<!doctype html>
<html lang="pt-br">

<head>
    <meta charset="utf-8" />
    <title>Admin — AlphaTech Orçamentos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='80'>⚡</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800&family=Exo+2:wght@700&family=Open+Sans:wght@400&display=swap"
        rel="stylesheet">

    <style>
        /* Paleta de Cores e Fontes da index.html */
        :root {
            --color-primary-dark: #0B132B;
            --color-secondary-gold: #FFD166;
            --color-accent-blue: #118AB2;
            --color-neutral-dark: #2E2E2E;
            --color-neutral-light: #E0E0E0;
            --color-card-dark-background: #1A243F;
            --color-segment-seg: #06D6A0;
            /* Verde para .ok */
            --color-error-red: #FF6B6B;
            /* Vermelho para .err */
        }

        body {
            background-color: var(--color-neutral-dark);
            color: var(--color-neutral-light);
            font-family: 'Open Sans', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .font-title {
            font-family: 'Montserrat', sans-serif;
        }

        .font-subtitle {
            font-family: 'Exo 2', sans-serif;
        }

        /* Estilos customizados para formulários no modo escuro */
        input[type="text"],
        input[type="email"],
        input[type="number"],
        input[type="password"],
        textarea,
        select {
            background-color: #2a3a5e;
            /* Um pouco mais claro que o card */
            border: 1px solid #4a5a7e;
            color: var(--color-neutral-light);
            border-radius: 0.5rem;
            /* 8px */
            padding: 0.5rem 0.75rem;
            /* 8px 12px */
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--color-accent-blue);
            box-shadow: 0 0 0 3px rgba(17, 138, 178, 0.5);
        }

        input[type="checkbox"] {
            border-radius: 0.25rem;
            border: 1px solid #4a5a7e;
            background-color: #2a3a5e;
            color: var(--color-accent-blue);
        }

        input[type="checkbox"]:checked {
            background-color: var(--color-accent-blue);
        }

        /* Classes de Botão */
        .btn {
            padding: 0.5rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 700;
            font-family: 'Exo 2', sans-serif;
            text-transform: uppercase;
            transition: all 0.3s ease;
            cursor: pointer;
            text-align: center;
        }

        .btn-primary {
            background-color: var(--color-accent-blue);
            color: white;
            box-shadow: 0 4px 15px rgba(17, 138, 178, 0.2);
        }

        .btn-primary:hover {
            background-color: #0e769c;
            /* Azul mais escuro */
            transform: translateY(-1px);
        }


        .btn-secondary {
            background-color: transparent;
            color: var(--color-secondary-gold);
            border: 2px solid var(--color-secondary-gold);
        }

        .btn-secondary:hover {
            background-color: var(--color-secondary-gold);
            color: var(--color-primary-dark);
        }

        .btn-save {
            background-color: var(--color-segment-seg);
            color: var(--color-primary-dark);
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 0.375rem;
        }

        .btn-save:hover {
            background-color: #05b38a;
        }


        /* Tabelas */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border-radius: 0.5rem;
            overflow: hidden;
        }

        th,
        td {
            padding: 0.75rem 1rem;
            /* 12px 16px */
            text-align: left;
            vertical-align: top;
            border-bottom: 1px solid #2a3a5e;
        }

        thead th {
            background-color: var(--color-primary-dark);
            color: var(--color-secondary-gold);
            font-family: 'Exo 2', sans-serif;
            text-transform: uppercase;
            font-size: 0.75rem;
            /* 12px */
            letter-spacing: 0.05em;
        }

        tbody tr {
            background-color: var(--color-card-dark-background);
        }

        tbody tr:hover {
            background-color: #2a3a5e;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        td select {
            padding: 0.375rem 0.5rem;
        }

        /* Card (substitui fieldset) */
        .card {
            background-color: var(--color-card-dark-background);
            border-radius: 0.75rem;
            /* 12px */
            padding: 1.5rem;
            /* 24px */
            margin-top: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .card-title {
            font-family: 'Exo 2', sans-serif;
            font-size: 1.5rem;
            /* 24px */
            font-weight: 700;
            color: white;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--color-secondary-gold);
            margin-bottom: 1rem;
        }

        /* Mensagens de Feedback */
        .ok {
            color: var(--color-segment-seg);
            font-weight: 600;
        }

        .err {
            color: var(--color-error-red);
            font-weight: 600;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

</head>

<body>

    <div class="max-w-7xl mx-auto p-4 md:p-8">

        <h1 class="font-title text-3xl sm:text-4xl font-extrabold uppercase flex items-center mb-6 text-white">
            <i data-lucide="zap" class="w-8 h-8 mr-2" style="color: var(--color-secondary-gold);"></i>
            <span>ALPHA</span><span style="color: var(--color-secondary-gold);">TECH</span>
            <span class="text-xl sm:text-2xl font-light opacity-70 ml-4">/ ADMIN</span>
        </h1>

        <div class="card">
            <div class="flex flex-col md:flex-row gap-4 items-center">
                <input id="token" type="text" placeholder="x-admin-token" class="w-full md:flex-grow" />
                <button id="loadQuotes" class="btn btn-primary w-full md:w-auto">Carregar orçamentos</button>
                <span id="fbQ" class="text-sm w-full md:w-auto text-center md:text-left"></span>
            </div>
        </div>

        <div class="card mt-8">
            <h2 class="card-title">Orçamentos Recebidos</h2>
            <div class="overflow-x-auto overflow-y-auto max-h-[70vh]">
                <table id="qt">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Cliente</th>
                            <th>Contato</th>
                            <th>Itens</th>
                            <th>Total (R$)</th>
                            <th>Obs</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>


        <div class="card">
            <h2 class="card-title">Gerenciar Serviços</h2>

            <div class="flex flex-col sm:flex-row gap-4 items-center mb-4">
                <button id="loadSvcs" class="btn btn-secondary w-full sm:w-auto">Listar serviços</button>
                <span id="fbS" class="ml-0 sm:ml-4 text-sm w-full sm:w-auto text-center sm:text-left"></span>
            </div>

            <div class="overflow-x-auto overflow-y-auto max-h-[70vh]">
                <table id="sv">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Descrição</th>
                            <th>Unidade</th>
                            <th>Preço base (R$)</th>
                            <th>Ativo</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>

            <h3 class="font-subtitle text-xl font-bold text-white mt-8 mb-4">Cadastrar novo serviço</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 items-center text-sm">
                <input id="sName" type="text" placeholder="Nome *" class="md:col-span-2 text-sm" />
                <input id="sUnit" type="text" placeholder="Unidade (un, ponto...)" value="un" />
                <input id="sPrice" placeholder="Preço base (ex: 150.00)" type="number" step="0.01" />
            </div>
            <textarea id="sDesc" placeholder="Descrição (opcional)" rows="3" class="w-full"></textarea>

            <div class="flex flex-col sm:flex-row sm:justify-between items-center mt-4 gap-4">
                <div class="flex items-center gap-2 text-sm">
                    <input id="sActive" type="checkbox" checked class="form-checkbox" />
                    <label for="sActive">Ativo (visível para orçamento)</label>
                </div>
                <button id="createSvc" class="btn btn-primary w-full sm:w-auto">Cadastrar serviço</button>
            </div>
        </div>
    </div>


    <script>
        // Inicializa ícones
        lucide.createIcons();

        const fbQ = document.getElementById('fbQ');
        const fbS = document.getElementById('fbS');

        function hdrs() {
            const token = document.getElementById('token').value.trim();
            if (!token) {
                alert('Por favor, insira o x-admin-token');
                throw new Error('Token não fornecido');
            }
            return { 'x-admin-token': token, 'Content-Type': 'application/json' };
        }

        // --- ORÇAMENTOS ---
        document.getElementById('loadQuotes').onclick = async () => {
            fbQ.textContent = 'Carregando...';
            fbQ.className = 'text-sm w-full md:w-auto text-center md:text-left';
            let headers;
            try { headers = hdrs(); } catch (e) { fbQ.textContent = e.message; fbQ.className = 'err text-sm w-full md:w-auto text-center md:text-left'; return; }

            const res = await fetch('/api/admin/quotes?page=1', { headers });
            const js = await res.json().catch(() => ({}));
            if (!res.ok) { fbQ.textContent = js.error || 'Erro'; fbQ.className = 'err text-sm w-full md:w-auto text-center md:text-left'; return; }
            fbQ.textContent = `Carregados ${js.quotes?.length || 0} orçamentos.`;
            fbQ.className = 'ok text-sm w-full md:w-auto text-center md:text-left';

            const tbody = document.querySelector('#qt tbody');
            tbody.innerHTML = '';

            const brl = n => (Number(n || 0)).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            (js.quotes || []).forEach(q => {
                const items = (js.itemsByQuote?.[q.id] || []);
                const total = js.totalsByQuote?.[q.id] || 0;

                // monta lista de itens com preço unitário e subtotal
                const itemsHtml = items.length ? items.map(it => {
                    const name = it.service?.name || '(?)';
                    const unit = it.service?.unit_label || 'un';
                    const qty = Number(it.quantity || 0);
                    const unitPrice = Number(it.service?.base_price ?? 0);
                    const sub = unitPrice * qty;
                    const det = it.detail ? ` <span class="opacity-70">— ${it.detail}</span>` : '';
                    return `<div class="text-xs">${name}: ${qty} ${unit} (${brl(unitPrice)} c/u) = <strong>${brl(sub)}</strong>${det}</div>`;
                }).join('') : '-';

                const rowId = q.id;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${new Date(q.created_at).toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' })}</td>
                    <td>${q.name || '-'}</td>
                    <td>${q.phone}${q.email ? '<br>' + q.email : ''}</td>
                    <td>${itemsHtml}</td>
                    <td><strong>${brl(total)}</strong></td>
                    <td>${q.notes || '-'}</td>
                    <td>
                        <select data-id="${q.id}" class="st">
                            ${['novo', 'contatado', 'fechado', 'perdido'].map(s => `<option value="${s}" ${s === q.status ? 'selected' : ''}>${s.charAt(0).toUpperCase() + s.slice(1)}</option>`).join('')}
                        </select>
                    </td>
                      <td>
                        <button class="btn-pdf" data-id="${rowId}">PDF</button>
                    </td>
                `;
                tbody.appendChild(tr);
                const btnPdf = tr.querySelector('.btn-pdf');
                btnPdf.onclick = () => {
                    const id = btnPdf.dataset.id;
                    const quote = (js.quotes || []).find(q => q.id === id);
                    const items = js.itemsByQuote?.[id] || [];
                    const total = js.totalsByQuote?.[id] || 0;
                    generateQuotePDF(quote, items, total);
                };

            });

            // Adiciona listener de mudança de status
            tbody.querySelectorAll('.st').forEach(sel => {
                sel.onchange = async (e) => {
                    const id = e.target.dataset.id;
                    const status = e.target.value;
                    let changeHeaders;
                    try { changeHeaders = hdrs(); } catch (e) { alert(e.message); return; }

                    const r = await fetch('/api/admin/quotes', {
                        method: 'PATCH',
                        headers: changeHeaders,
                        body: JSON.stringify({ id, status })
                    });
                    if (!r.ok) {
                        alert('Falha ao atualizar status');
                        // Reverte a seleção em caso de falha
                        sel.value = [...sel.options].find(o => o.defaultSelected)?.value || sel.options[0].value;
                    }
                };
            });
        };

        // --- SERVIÇOS ---
        document.getElementById('loadSvcs').onclick = async () => {
            fbS.textContent = 'Carregando...';
            fbS.className = 'ml-0 sm:ml-4 text-sm w-full sm:w-auto text-center sm:text-left';
            let headers;
            try { headers = hdrs(); } catch (e) { fbS.textContent = e.message; fbS.className = 'err ml-0 sm:ml-4 text-sm w-full sm:w-auto text-center sm:text-left'; return; }

            const res = await fetch('/api/admin/services', { headers });
            const js = await res.json().catch(() => ({}));
            if (!res.ok) { fbS.textContent = js.error || 'Erro'; fbS.className = 'err ml-0 sm:ml-4 text-sm w-full sm:w-auto text-center sm:text-left'; return; }
            fbS.textContent = `Carregados ${js.services?.length || 0} serviços.`;
            fbS.className = 'ok ml-0 sm:ml-4 text-sm w-full sm:w-auto text-center sm:text-left';

            const tbody = document.querySelector('#sv tbody');
            tbody.innerHTML = '';
            (js.services || []).forEach(s => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="text" value="${s.name || ''}" data-k="name" data-id="${s.id}" class="w-full" /></td>
                    <td><input type="text" value="${s.description || ''}" data-k="description" data-id="${s.id}" class="w-full" /></td>
                    <td><input type="text" value="${s.unit_label || 'un'}" data-k="unit_label" data-id="${s.id}" class="w-20"/></td>
                    <td><input value="${s.base_price ?? ''}" data-k="base_price" data-id="${s.id}" type="number" step="0.01" class="w-28"/></td>
                    <td><input type="checkbox" ${s.active ? 'checked' : ''} data-k="active" data-id="${s.id}" class="form-checkbox" /></td>
                    <td><button class="btn btn-save save" data-id="${s.id}">Salvar</button></td>
                `;
                tbody.appendChild(tr);
            });

            // Listener para salvar serviço
            tbody.querySelectorAll('.save').forEach(btn => {
                btn.onclick = async () => {
                    const id = btn.dataset.id;
                    const row = tbody.querySelectorAll(`[data-id="${id}"]`);
                    const payload = { id };
                    row.forEach(inp => {
                        const k = inp.dataset.k;
                        payload[k] = (inp.type === 'checkbox') ? inp.checked
                            : (inp.type === 'number' && inp.value !== '' ? Number(inp.value) : (inp.value || null));
                    });

                    let saveHeaders;
                    try { saveHeaders = hdrs(); } catch (e) { alert(e.message); return; }

                    btn.textContent = '...';
                    const r = await fetch('/api/admin/services', {
                        method: 'PATCH',
                        headers: saveHeaders,
                        body: JSON.stringify(payload)
                    });
                    if (!r.ok) {
                        alert('Falha ao salvar serviço');
                        btn.textContent = 'Salvar';
                    } else {
                        btn.textContent = 'Salvo!';
                        setTimeout(() => { btn.textContent = 'Salvar'; }, 1500);
                    }
                };
            });
        };

        // --- CRIAR SERVIÇO ---
        document.getElementById('createSvc').onclick = async () => {
            const payload = {
                name: document.getElementById('sName').value,
                description: document.getElementById('sDesc').value || null,
                unit_label: document.getElementById('sUnit').value || 'un',
                base_price: document.getElementById('sPrice').value ? Number(document.getElementById('sPrice').value) : null,
                active: document.getElementById('sActive').checked
            };

            if (!payload.name) {
                alert('O campo "Nome" é obrigatório.');
                return;
            }

            let createHeaders;
            try { createHeaders = hdrs(); } catch (e) { alert(e.message); return; }

            const btn = document.getElementById('createSvc');
            btn.textContent = 'Cadastrando...';
            btn.disabled = true;

            const res = await fetch('/api/admin/services', {
                method: 'POST',
                headers: createHeaders,
                body: JSON.stringify(payload)
            });

            btn.disabled = false;
            btn.textContent = 'Cadastrar serviço';

            if (res.ok) {
                // Limpa o formulário
                document.getElementById('sName').value = '';
                document.getElementById('sDesc').value = '';
                document.getElementById('sUnit').value = 'un';
                document.getElementById('sPrice').value = '';
                document.getElementById('sActive').checked = true;
                // Recarrega a lista
                document.getElementById('loadSvcs').click();
            } else {
                const js = await res.json().catch(() => ({}));
                alert(js.error || 'Erro ao criar serviço');
            }
        };


        // personalize os dados da empresa aqui
        const COMPANY = {
            name: 'AlphaTech Elétrica & Automação',
            doc: 'CNPJ 56.888.854/0001-00',
            phone: '(11) 93088-8270',
            email: 'Alphatech.escri@gmail.com',
            address: 'R. Vicente Paulo da Costa - Jordanésia, Cajamar - SP.',
            site: 'https://alphatech-plum.vercel.app/',
            logoUrl: new URL('/assets/logo.png', location.origin).href // opcional: URL absoluta do logo (PNG)
        };

        const brl = n => (Number(n || 0)).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        async function generateQuotePDF(q, items, total) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: 'a4' });

            // ===== Layout fixo e margens =====
            const M = 40;                                  // margem
            const pageW = doc.internal.pageSize.getWidth();
            const pageH = doc.internal.pageSize.getHeight();
            const headerH = 110;                           // reserva cabeçalho
            const footerH = 40;                            // reserva rodapé
            const innerW = pageW - 2 * M;

            // ===== Logo (carrega uma vez) =====
            let logoDataUrl = null, logoW = 0, logoH = 0;
            if (COMPANY.logoUrl) {
                try {
                    const blob = await fetch(COMPANY.logoUrl, { cache: 'no-store' }).then(r => r.blob());
                    const reader = new FileReader();
                    await new Promise(res => { reader.onload = res; reader.readAsDataURL(blob); });
                    logoDataUrl = reader.result;
                    // define tamanho máximo sem invadir textos
                    logoW = 110; logoH = 36;                   // estável, sem alongar
                } catch (_) { }
            }

            // ===== Cabeçalho/rodapé simples, sem ícones/bullets =====
            function drawHeader() {
                const yTop = M;

                // 1) Logo (esquerda)
                if (logoDataUrl) {
                    doc.addImage(logoDataUrl, 'PNG', M, yTop, logoW, logoH, undefined, 'FAST');
                }

                // 2) Dados da empresa (direita)
                const rightX = M + (logoDataUrl ? (logoW + 16) : 0); // recua se tiver logo
                const rightW = innerW - (logoDataUrl ? (logoW + 16) : 0);

                doc.setFont('helvetica', 'bold'); doc.setTextColor(0); doc.setFontSize(14);
                doc.text(COMPANY.name, rightX, yTop + 16, { maxWidth: rightW });

                doc.setFont('helvetica', 'normal'); doc.setTextColor(60); doc.setFontSize(10);
                const compLines = [
                    COMPANY.doc,
                    COMPANY.address,
                    `${COMPANY.phone} / ${COMPANY.email}`,
                    COMPANY.site
                ];
                let yy = yTop + 32;
                compLines.forEach(line => { doc.text(line, rightX, yy, { maxWidth: rightW }); yy += 14; });

                // 3) Linha separadora
                const sepY = M + 80;
                doc.setDrawColor(220); doc.line(M, sepY, pageW - M, sepY);
            }

            function drawFooter(pageNumber, pageCount) {
                const y = pageH - M;
                doc.setFont('helvetica', 'normal'); doc.setTextColor(90); doc.setFontSize(9);
                const disclaimer = 'Este documento é uma estimativa. Valores finais podem variar após visita técnica/ajustes de escopo.';
                doc.text(disclaimer, M, y, { maxWidth: innerW });
                doc.text(`Página ${pageNumber} de ${pageCount}`, pageW - M, y, { align: 'right' });
            }

            // ===== Título + meta (página 1) =====
            const yTop = M + headerH;
            doc.setFont('helvetica', 'bold'); doc.setTextColor(0); doc.setFontSize(18);
            doc.text('Orçamento', M, yTop);

            const created = new Date(q.created_at);
            doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
            doc.text(`#${q.id.slice(0, 8)}`, M, yTop + 18);
            doc.text(`Data: ${created.toLocaleDateString('pt-BR')} ${created.toLocaleTimeString('pt-BR')}`, M, yTop + 32);

            // bloco Cliente (coluna à direita, sem ícone)
            const clienteX = pageW / 2 + 20;
            doc.setFont('helvetica', 'bold'); doc.text('Cliente', clienteX, yTop);
            doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
            const clientLines = [
                `Nome: ${q.name || '-'}`,
                `WhatsApp: ${q.phone || '-'}`,
                `E-mail: ${q.email || '-'}`
            ];
            let cy = yTop + 16;
            clientLines.forEach(line => { doc.text(line, clienteX, cy, { maxWidth: innerW / 2 - 20 }); cy += 14; });

            // ===== Tabela de itens (sem emojis/bullets) =====
            const rows = (items || []).map(it => {
                const name = it.service?.name || '(?)';
                const unit = it.service?.unit_label || 'un';
                const qty = Number(it.quantity || 0);
                const unitPrice = Number(it.service?.base_price ?? 0);
                const sub = unitPrice * qty;
                return [name, it.detail || '', `${qty} ${unit}`, brl(unitPrice), brl(sub)];
            });

            doc.autoTable({
                head: [['Serviço', 'Detalhe', 'Qtd', 'Unitário', 'Subtotal']],
                body: rows.length ? rows : [['(sem itens)', '', '', '', '']],
                startY: yTop + 48,
                margin: { top: M + headerH, bottom: M + footerH, left: M, right: M },
                styles: {
                    font: 'helvetica', fontSize: 10, cellPadding: 6, overflow: 'linebreak',
                    lineColor: [230, 233, 238], lineWidth: 0.6, textColor: 20
                },
                headStyles: { fillColor: [23, 37, 84], textColor: 255, halign: 'left' },
                bodyStyles: { fillColor: [255, 255, 255] },
                alternateRowStyles: { fillColor: [246, 248, 250] },
                theme: 'grid',
                // larguras que cabem no innerW sem sobrar/estourar
                columnStyles: {
                    0: { cellWidth: 175 },          // Serviço
                    1: { cellWidth: 135 },          // Detalhe
                    2: { cellWidth: 55, halign: 'center' },
                    3: { cellWidth: 65, halign: 'right' },
                    4: { cellWidth: 85, halign: 'right' }
                },
                didDrawPage: (data) => {
                    drawHeader();
                    drawFooter(data.pageNumber, doc.internal.getNumberOfPages());
                }
            });

            // ===== Pós-tabela =====
            let y = doc.lastAutoTable.finalY + 16;
            const usableBottom = pageH - M - footerH;
            const ensure = (h) => {
                if (y + h > usableBottom) {
                    doc.addPage();
                    // header/rodapé redesenhados pelo didDrawPage
                    y = M + headerH;
                }
            };

            // Observações (sem ícone)
            if (q.notes) {
                doc.setFont('helvetica', 'bold'); doc.setTextColor(0); doc.setFontSize(11);
                const titleH = 14;
                const notes = doc.splitTextToSize(q.notes, innerW);
                const lineH = 12;
                const textH = notes.length * lineH;

                ensure(titleH + 6 + textH);
                doc.text('Observações', M, y); y += titleH;
                doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
                doc.text(notes, M, y + 4); y += (textH + 6);
            }

            // Total (caixa simples, sem ícone)
            ensure(40);
            const boxW = 220, boxH = 32, boxX = pageW - M - boxW, boxY = y;
            doc.setDrawColor(23, 37, 84); doc.setLineWidth(0.8);
            doc.roundedRect(boxX, boxY, boxW, boxH, 6, 6);
            doc.setFont('helvetica', 'bold'); doc.setFontSize(11);
            doc.text('Total estimado', boxX + 10, boxY + 14);
            doc.setFont('helvetica', 'bold'); doc.setFontSize(13);
            doc.text(brl(total), boxX + boxW - 10, boxY + 22, { align: 'right' });

            // arquivo
            const fname = `orcamento_${(q.name || 'cliente').toString().trim().replace(/\s+/g, '_')}_${q.id.slice(0, 8)}.pdf`;
            doc.save(fname);
        }


    </script>
</body>

</html>
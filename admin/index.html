<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>AlphaTech | Painel Administrativo Geral</title>

    <meta name="robots" content="noindex, nofollow">

    <!-- Favicon -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='80'>⚡</text></svg>">

    <!-- Bibliotecas -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
    
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800&family=Exo+2:wght@700&family=Open+Sans:wght@400;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        /* === Identidade Visual AlphaTech === */
        :root {
            --color-primary-dark: #0B132B;
            --color-secondary-gold: #FFD166;
            --color-accent-blue: #118AB2;
            --color-neutral-dark: #2E2E2E;
            --color-card-dark-background: #1A243F;
        }

        body {
            font-family: 'Open Sans', sans-serif;
            background-color: #f7f9fc;
            color: var(--color-neutral-dark);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Tipografia */
        .font-title { font-family: 'Montserrat', sans-serif; }
        .font-subtitle { font-family: 'Exo 2', sans-serif; }
        .logo-text-gold { color: var(--color-secondary-gold); }

        /* Botões */
        .btn-primary {
            background-color: var(--color-accent-blue);
            color: white;
            transition: all 0.3s;
        }
        .btn-primary:hover {
            background-color: #0c6a8f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(17, 138, 178, 0.4);
        }

        .btn-secondary {
            background-color: #fff;
            color: var(--color-primary-dark);
            border: 1px solid #e5e7eb;
            transition: all 0.3s;
        }
        .btn-secondary:hover {
            background-color: #f3f4f6;
            border-color: var(--color-primary-dark);
        }

        /* Inputs */
        .admin-input {
            background-color: #fff;
            border: 1px solid #d1d5db;
            color: #111827;
            transition: all 0.2s;
        }
        .admin-input:focus {
            outline: none;
            border-color: var(--color-accent-blue);
            box-shadow: 0 0 0 3px rgba(17, 138, 178, 0.1);
        }

        /* Tabelas e Status */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        .status-novo { background-color: #dbeafe; color: #1e40af; }
        .status-contatado { background-color: #fef3c7; color: #92400e; }
        .status-fechado { background-color: #dcfce7; color: #166534; }
        .status-perdido { background-color: #fee2e2; color: #991b1b; }
    </style>
</head>

<body class="bg-gray-50">

    <!-- === HEADER === -->
    <header class="sticky top-0 z-50 shadow-lg bg-[#0B132B]">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between">
            <!-- Logo -->
            <a href="/index.html" class="text-2xl sm:text-3xl font-title font-extrabold uppercase flex items-center whitespace-nowrap no-underline">
                <i data-lucide="zap" class="w-7 h-7 sm:w-8 sm:h-8 text-yellow-400 mr-1"></i>
                <span class="text-white">ALPHA</span><span class="logo-text-gold">TECH</span>
            </a>

            <!-- Navegação Admin -->
            <div class="flex items-center gap-4">
                <a href="afiliados.html" class="hidden md:flex items-center gap-2 text-sm font-bold text-gray-300 hover:text-white transition px-3 py-2 rounded-lg hover:bg-white/10">
                    <i class="fas fa-store"></i> Painel de Afiliados
                </a>
                <div class="text-white font-subtitle opacity-80 text-sm hidden sm:block border-l border-gray-600 pl-4 ml-2">
                    <i class="fas fa-tools mr-2"></i> Gestão Geral
                </div>
            </div>
        </div>
    </header>

    <!-- === CONTEÚDO PRINCIPAL === -->
    <main class="flex-grow py-10 px-4 sm:px-6 lg:px-8">
        <div class="max-w-7xl mx-auto space-y-10">
            
            <!-- 1. BARRA DE CONTROLE E ACESSO -->
            <div class="bg-white rounded-2xl shadow-md p-6 border border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h1 class="text-2xl font-title font-bold text-gray-800 uppercase">Dashboard</h1>
                    <p class="text-sm text-gray-500">Insira sua credencial para gerenciar dados.</p>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto items-center">
                    <div class="relative w-full md:w-64">
                        <span class="absolute left-3 top-2.5 text-gray-400"><i class="fas fa-key"></i></span>
                        <input id="token" type="password" class="admin-input w-full rounded-lg pl-9 pr-3 py-2 text-sm" placeholder="Token de Administrador" />
                    </div>
                    <button id="loadDataBtn" class="btn-primary px-6 py-2 rounded-lg font-bold text-sm w-full sm:w-auto shadow-md flex items-center justify-center gap-2">
                        <i class="fas fa-sync-alt"></i> Carregar Dados
                    </button>
                </div>
            </div>

            <p id="globalFb" class="text-center font-bold hidden"></p>

            <!-- 2. SEÇÃO DE ORÇAMENTOS (TABELA WIDE) -->
            <section>
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl md:text-2xl font-title font-bold text-gray-800 uppercase border-l-4 border-yellow-400 pl-3">
                        Orçamentos <span style="color: var(--color-accent-blue);">Recebidos</span>
                    </h2>
                </div>

                <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
                    <div class="overflow-x-auto">
                        <table id="quotesTable" class="w-full text-left border-collapse">
                            <thead class="bg-gray-100 text-gray-600 uppercase text-xs font-bold">
                                <tr>
                                    <th class="px-4 py-3 whitespace-nowrap">Data</th>
                                    <th class="px-4 py-3">Cliente</th>
                                    <th class="px-4 py-3">Itens do Pedido</th>
                                    <th class="px-4 py-3 text-right">Total</th>
                                    <th class="px-4 py-3 w-40">Status</th>
                                    <th class="px-4 py-3 text-right">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="quotesTbody" class="divide-y divide-gray-100 text-sm text-gray-700">
                                <tr>
                                    <td colspan="6" class="px-6 py-8 text-center text-gray-400 italic">
                                        Aguardando carregamento dos dados...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- 3. SEÇÃO DE SERVIÇOS (GRID: FORM + LISTA) -->
            <section>
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl md:text-2xl font-title font-bold text-gray-800 uppercase border-l-4 border-blue-500 pl-3">
                        Catálogo de <span style="color: var(--color-accent-blue);">Serviços</span>
                    </h2>
                    <button id="newServiceBtn" class="text-sm text-blue-600 hover:text-blue-800 font-bold md:hidden">
                        + Novo Serviço
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    
                    <!-- FORMULÁRIO DE SERVIÇO (Esquerda) -->
                    <div class="lg:col-span-1">
                        <div class="bg-white rounded-2xl shadow-xl overflow-hidden sticky top-24 border border-gray-100">
                            <div class="p-4 bg-gray-800 text-white font-subtitle font-bold flex justify-between items-center">
                                <span><i class="fas fa-edit mr-2"></i> Gerenciar Serviço</span>
                                <button id="resetSvcBtn" class="text-xs bg-gray-600 hover:bg-gray-500 px-2 py-1 rounded text-white transition">Novo</button>
                            </div>
                            
                            <form id="serviceForm" class="p-6 space-y-4">
                                <input type="hidden" id="svcId">
                                
                                <div>
                                    <label class="block text-xs font-bold text-gray-700 mb-1 uppercase">Nome do Serviço *</label>
                                    <input id="sName" class="admin-input w-full rounded-lg px-3 py-2 text-sm" placeholder="Ex: Instalação de Tomada" required />
                                </div>

                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-700 mb-1 uppercase">Unidade</label>
                                        <input id="sUnit" class="admin-input w-full rounded-lg px-3 py-2 text-sm" placeholder="un, m, pt" value="un" />
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-700 mb-1 uppercase">Preço Base (R$)</label>
                                        <input id="sPrice" type="number" step="0.01" class="admin-input w-full rounded-lg px-3 py-2 text-sm" placeholder="0.00" />
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-gray-700 mb-1 uppercase">Descrição</label>
                                    <textarea id="sDesc" rows="3" class="admin-input w-full rounded-lg px-3 py-2 text-sm" placeholder="Detalhes técnicos..."></textarea>
                                </div>

                                <div class="flex items-center pt-2">
                                    <label class="inline-flex items-center cursor-pointer">
                                        <input id="sActive" type="checkbox" class="sr-only peer" checked>
                                        <div class="relative w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                                        <span class="ms-2 text-sm font-medium text-gray-700">Ativo no Site</span>
                                    </label>
                                </div>

                                <div class="pt-2">
                                    <button type="submit" id="svcSubmitBtn" class="w-full btn-primary py-2.5 rounded-xl font-bold uppercase text-sm shadow-lg">
                                        <i class="fas fa-save mr-2"></i> Salvar Serviço
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- LISTA DE SERVIÇOS (Direita) -->
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100 h-full flex flex-col">
                            <div class="overflow-x-auto flex-grow">
                                <table class="w-full text-left border-collapse">
                                    <thead class="bg-gray-50 text-gray-600 uppercase text-xs font-bold">
                                        <tr>
                                            <th class="px-4 py-3">Serviço</th>
                                            <th class="px-4 py-3 w-24">Unid.</th>
                                            <th class="px-4 py-3 w-32 text-right">Preço</th>
                                            <th class="px-4 py-3 w-24 text-center">Status</th>
                                            <th class="px-4 py-3 w-16"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="servicesTbody" class="divide-y divide-gray-100 text-sm text-gray-700">
                                        <!-- JS Preenche -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </section>

        </div>
    </main>

    <!-- === FOOTER === -->
    <footer class="py-6 mt-auto bg-[#0B132B]">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-sm text-white opacity-60 font-opensans">
                © 2025 AlphaTech - Painel Administrativo.
            </p>
        </div>
    </footer>

    <!-- === LÓGICA JAVASCRIPT === -->
    <script>
        lucide.createIcons();

        // --- DADOS DA EMPRESA (Para PDF) ---
        const COMPANY = {
            name: 'AlphaTech Elétrica & Automação',
            doc: 'CNPJ 56.888.854/0001-00',
            phone: '(11) 93088-8270',
            email: 'Alphatech.escri@gmail.com',
            address: 'R. Vicente Paulo da Costa - Jordanésia, Cajamar - SP.',
            site: 'https://alphatech-plum.vercel.app/',
            logoUrl: '/assets/logo.png' // Ajuste se necessário
        };

        // Elementos DOM
        const tokenInput = document.getElementById('token');
        const loadDataBtn = document.getElementById('loadDataBtn');
        const globalFb = document.getElementById('globalFb');
        
        // Quotes
        const quotesTbody = document.getElementById('quotesTbody');

        // Services
        const serviceForm = document.getElementById('serviceForm');
        const sName = document.getElementById('sName');
        const sUnit = document.getElementById('sUnit');
        const sPrice = document.getElementById('sPrice');
        const sDesc = document.getElementById('sDesc');
        const sActive = document.getElementById('sActive');
        const svcIdInput = document.getElementById('svcId');
        const servicesTbody = document.getElementById('servicesTbody');
        const svcSubmitBtn = document.getElementById('svcSubmitBtn');
        const resetSvcBtn = document.getElementById('resetSvcBtn');
        const newServiceBtn = document.getElementById('newServiceBtn');

        let editingSvcId = null;

        // --- UTILITÁRIOS ---
        const formatBRL = (n) => (Number(n || 0)).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        
        function getHeaders() {
            const t = tokenInput.value.trim();
            if(!t) throw new Error('Token de administrador obrigatório.');
            return { 'x-admin-token': t, 'Content-Type': 'application/json' };
        }

        function showFeedback(msg, type = 'info') {
            globalFb.textContent = msg;
            globalFb.className = `text-center font-bold text-sm py-2 px-4 rounded mb-4 ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'} block`;
            setTimeout(() => globalFb.classList.add('hidden'), 5000);
        }

        // --- CARREGAMENTO GERAL ---
        loadDataBtn.onclick = async () => {
            try {
                const h = getHeaders(); // Valida token
                loadDataBtn.disabled = true;
                loadDataBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
                
                await Promise.all([loadQuotes(h), loadServices(h)]);
                
                showFeedback('Dados atualizados com sucesso!', 'success');
            } catch (err) {
                showFeedback(err.message, 'error');
            } finally {
                loadDataBtn.disabled = false;
                loadDataBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Carregar Dados';
            }
        };

        // --- ORÇAMENTOS (QUOTES) ---
        async function loadQuotes(headers) {
            const res = await fetch('/api/admin/quotes?page=1', { headers });
            if (!res.ok) throw new Error('Falha ao carregar orçamentos.');
            const js = await res.json();
            
            renderQuotes(js.quotes || [], js.itemsByQuote || {}, js.totalsByQuote || {});
        }

        function renderQuotes(quotes, itemsMap, totalsMap) {
            quotesTbody.innerHTML = '';
            
            if(quotes.length === 0) {
                quotesTbody.innerHTML = '<tr><td colspan="6" class="p-6 text-center text-gray-500">Nenhum orçamento recebido.</td></tr>';
                return;
            }

            quotes.forEach(q => {
                const items = itemsMap[q.id] || [];
                const total = totalsMap[q.id] || 0;
                
                // Resumo dos itens (HTML)
                const itemsSummary = items.map(it => 
                    `<div class="text-xs mb-1">
                        <span class="font-bold text-gray-700">${it.quantity}x</span> ${it.service?.name || 'Item removido'}
                    </div>`
                ).join('') || '<span class="text-gray-400 italic">Sem itens</span>';

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-blue-50 transition';
                
                // Seletor de Status
                const statusOptions = ['novo', 'contatado', 'fechado', 'perdido'].map(st => 
                    `<option value="${st}" ${q.status === st ? 'selected' : ''}>${st.toUpperCase()}</option>`
                ).join('');

                tr.innerHTML = `
                    <td class="px-4 py-4 align-top whitespace-nowrap text-xs text-gray-500">
                        ${new Date(q.created_at).toLocaleDateString('pt-BR')}<br>
                        ${new Date(q.created_at).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}
                    </td>
                    <td class="px-4 py-4 align-top">
                        <div class="font-bold text-gray-800">${q.name || 'Desconhecido'}</div>
                        <div class="text-xs text-gray-500 flex flex-col mt-1 gap-1">
                            ${q.email ? `<span><i class="fas fa-envelope w-4"></i> ${q.email}</span>` : ''}
                            ${q.phone ? `<span><i class="fas fa-whatsapp w-4"></i> ${q.phone}</span>` : ''}
                        </div>
                        ${q.notes ? `<div class="mt-2 text-xs bg-yellow-50 p-2 rounded text-gray-600 border border-yellow-100 italic">Obs: ${q.notes}</div>` : ''}
                    </td>
                    <td class="px-4 py-4 align-top">
                        ${itemsSummary}
                    </td>
                    <td class="px-4 py-4 align-top text-right font-bold text-gray-800">
                        ${formatBRL(total)}
                    </td>
                    <td class="px-4 py-4 align-top">
                        <select class="text-xs border border-gray-300 rounded p-1.5 w-full bg-white focus:ring-2 focus:ring-blue-200 outline-none status-select" data-id="${q.id}">
                            ${statusOptions}
                        </select>
                    </td>
                    <td class="px-4 py-4 align-top text-right">
                        <button class="text-red-600 hover:bg-red-50 border border-red-200 rounded-lg px-3 py-1.5 text-xs font-bold transition btn-pdf" data-id="${q.id}">
                            <i class="fas fa-file-pdf mr-1"></i> PDF
                        </button>
                    </td>
                `;
                
                // Evento Troca Status
                tr.querySelector('.status-select').addEventListener('change', async (e) => {
                    try {
                        const h = getHeaders();
                        await fetch('/api/admin/quotes', {
                            method: 'PATCH',
                            headers: h,
                            body: JSON.stringify({ id: q.id, status: e.target.value })
                        });
                        e.target.classList.add('bg-green-50', 'border-green-300');
                        setTimeout(() => e.target.classList.remove('bg-green-50', 'border-green-300'), 1000);
                    } catch (err) {
                        alert('Erro ao mudar status: ' + err.message);
                    }
                });

                // Evento PDF
                tr.querySelector('.btn-pdf').onclick = () => generateQuotePDF(q, items, total);

                quotesTbody.appendChild(tr);
            });
        }

        // --- SERVIÇOS (SERVICES) ---
        async function loadServices(headers) {
            const res = await fetch('/api/admin/services', { headers });
            if (!res.ok) throw new Error('Falha ao carregar serviços.');
            const js = await res.json();
            renderServices(js.services || []);
        }

        function renderServices(list) {
            servicesTbody.innerHTML = '';
            list.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-blue-50 transition group';
                
                tr.innerHTML = `
                    <td class="px-4 py-3 align-middle">
                        <div class="font-bold text-gray-800">${s.name}</div>
                        <div class="text-xs text-gray-500 truncate max-w-[200px]">${s.description || '-'}</div>
                    </td>
                    <td class="px-4 py-3 align-middle text-gray-600 text-xs font-mono">${s.unit_label || 'un'}</td>
                    <td class="px-4 py-3 align-middle text-right font-semibold text-gray-700">${formatBRL(s.base_price)}</td>
                    <td class="px-4 py-3 align-middle text-center">
                        ${s.active 
                            ? '<span class="w-2 h-2 bg-green-500 rounded-full inline-block" title="Ativo"></span>' 
                            : '<span class="w-2 h-2 bg-red-400 rounded-full inline-block" title="Inativo"></span>'}
                    </td>
                    <td class="px-4 py-3 align-middle text-right">
                        <button class="text-blue-600 hover:bg-blue-100 p-2 rounded-lg transition edit-svc-btn">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                    </td>
                `;
                
                // Botão Editar preenche o form
                tr.querySelector('.edit-svc-btn').onclick = () => {
                    editingSvcId = s.id;
                    svcIdInput.value = s.id;
                    sName.value = s.name;
                    sDesc.value = s.description || '';
                    sUnit.value = s.unit_label || 'un';
                    sPrice.value = s.base_price || '';
                    sActive.checked = !!s.active;
                    
                    svcSubmitBtn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i> Atualizar';
                    svcSubmitBtn.classList.replace('btn-primary', 'bg-yellow-500');
                    svcSubmitBtn.classList.add('text-white', 'hover:bg-yellow-600');
                    
                    // Scroll mobile
                    if(window.innerWidth < 1024) serviceForm.scrollIntoView({behavior:'smooth'});
                };

                servicesTbody.appendChild(tr);
            });
        }

        // Reset Form Serviço
        function resetSvcForm() {
            editingSvcId = null;
            svcIdInput.value = '';
            serviceForm.reset();
            sActive.checked = true;
            sUnit.value = 'un';
            svcSubmitBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Salvar Serviço';
            svcSubmitBtn.className = 'w-full btn-primary py-2.5 rounded-xl font-bold uppercase text-sm shadow-lg';
        }
        
        resetSvcBtn.onclick = resetSvcForm;
        newServiceBtn.onclick = () => {
            resetSvcForm();
            serviceForm.scrollIntoView({behavior:'smooth'});
        };

        // Salvar Serviço (Create/Update)
        serviceForm.onsubmit = async (e) => {
            e.preventDefault();
            
            const payload = {
                name: sName.value,
                description: sDesc.value || null,
                unit_label: sUnit.value || 'un',
                base_price: sPrice.value ? Number(sPrice.value) : null,
                active: sActive.checked
            };

            // Se for edição, inclui ID
            if (editingSvcId) payload.id = editingSvcId;

            try {
                const h = getHeaders();
                svcSubmitBtn.disabled = true;
                svcSubmitBtn.textContent = 'Processando...';

                // Usa PATCH para update e POST para create
                const method = editingSvcId ? 'PATCH' : 'POST';
                
                const res = await fetch('/api/admin/services', {
                    method: method,
                    headers: h,
                    body: JSON.stringify(payload)
                });

                if(!res.ok) {
                    const js = await res.json();
                    throw new Error(js.error || 'Erro ao salvar.');
                }

                showFeedback(editingSvcId ? 'Serviço atualizado!' : 'Serviço criado!', 'success');
                resetSvcForm();
                loadServices(h); // Recarrega lista
                
            } catch (err) {
                showFeedback(err.message, 'error');
            } finally {
                svcSubmitBtn.disabled = false;
                if(!editingSvcId) svcSubmitBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Salvar Serviço';
            }
        };

        // --- GERAÇÃO DE PDF (Copiado e adaptado da original) ---
        async function generateQuotePDF(q, items, total) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: 'pt', format: 'a4' });

            const M = 40; 
            const pageW = doc.internal.pageSize.getWidth();
            const pageH = doc.internal.pageSize.getHeight();
            const innerW = pageW - 2 * M;

            // Cabeçalho
            let y = M;
            doc.setFont('helvetica', 'bold'); doc.setFontSize(18); doc.setTextColor(11, 19, 43);
            doc.text(COMPANY.name, M, y);
            
            doc.setFont('helvetica', 'normal'); doc.setFontSize(9); doc.setTextColor(100);
            y += 14; doc.text(`${COMPANY.doc} | ${COMPANY.phone}`, M, y);
            y += 12; doc.text(COMPANY.email, M, y);
            
            doc.setDrawColor(220); doc.line(M, y+10, pageW-M, y+10);
            
            // Info do Orçamento
            y += 40;
            doc.setFontSize(14); doc.setTextColor(0); doc.setFont('helvetica', 'bold');
            doc.text(`Orçamento #${q.id.toString().slice(0,6).toUpperCase()}`, M, y);
            
            y += 16;
            doc.setFontSize(10); doc.setFont('helvetica', 'normal');
            doc.text(`Data: ${new Date(q.created_at).toLocaleDateString()}`, M, y);
            
            // Cliente Box
            y += 20;
            doc.setFillColor(247, 249, 252); doc.roundedRect(M, y, innerW, 50, 4, 4, 'F');
            doc.setFont('helvetica', 'bold'); doc.text('Cliente:', M + 10, y + 18);
            doc.setFont('helvetica', 'normal'); 
            doc.text(`${q.name} ${q.phone ? ' - ' + q.phone : ''}`, M + 10, y + 32);
            doc.text(q.email || '', M + 10, y + 44);

            // Tabela
            const rows = items.map(it => [
                it.service?.name || 'Item',
                it.quantity,
                formatBRL(it.service?.base_price),
                formatBRL((it.service?.base_price || 0) * it.quantity)
            ]);

            doc.autoTable({
                head: [['Descrição', 'Qtd', 'Unitário', 'Subtotal']],
                body: rows,
                startY: y + 60,
                margin: { left: M, right: M },
                styles: { font: 'helvetica', fontSize: 10, cellPadding: 6 },
                headStyles: { fillColor: [11, 19, 43], textColor: 255 },
                theme: 'grid'
            });

            // Total e Obs
            let finalY = doc.lastAutoTable.finalY + 20;
            
            // Observações
            if(q.notes) {
                doc.setFont('helvetica', 'bold'); doc.text('Observações:', M, finalY);
                doc.setFont('helvetica', 'normal');
                const splitNotes = doc.splitTextToSize(q.notes, innerW);
                doc.text(splitNotes, M, finalY + 12);
                finalY += (splitNotes.length * 12) + 20;
            }

            // Total Box
            doc.setFontSize(12); doc.setFont('helvetica', 'bold');
            doc.text(`TOTAL ESTIMADO: ${formatBRL(total)}`, pageW - M, finalY, { align: 'right' });
            
            // Disclaimer
            doc.setFontSize(8); doc.setTextColor(150); doc.setFont('helvetica', 'italic');
            doc.text('Valores sujeitos a alteração após visita técnica.', M, pageH - 20);

            doc.save(`Orcamento_${q.name}_${q.id.slice(0,4)}.pdf`);
        }
    </script>
</body>
</html>